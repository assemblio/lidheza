{% extends "layout.html" %}

{% block script %}
    <script>
        $(function() {
            $( ".btn-edit-stopped" ).click(function() {
                editCampaign('.form-stopped', 'stopped-campaign-id');
            });

            $( ".btn-edit-published" ).click(function() {
                editCampaign('.form-published', 'published-campaign-id');
            });

            $( ".btn-edit-draft" ).click(function() {
                editCampaign('.form-draft', 'draft-campaign-id');
            });

            $( ".btn-play-draft" ).click(function() {
                publishCampaign('.form-draft', 'draft-campaign-id');
            });

            $( ".btn-play-stopped" ).click(function() {
                publishCampaign('.form-stopped', 'stopped-campaign-id');

            });

            $( ".btn-delete-draft" ).click(function() {
                var campaign_id = $(this).parent().find('input[id=draft-campaign-id]').val();
                var action = '{{ url_for('publisher.campaign_delete', pid=publisher._id, campaign_id='XXX')}}'.replace('XXX', campaign_id);

                $('.form-published').attr('method', 'POST');
                $('.form-published').attr('action', action);
                $('.form-published').submit();
            });

            $( ".btn-stop-published" ).click(function() {
                var campaign_id = $(this).parent().find('input[id=published-campaign-id]').val();
                var action = '{{ url_for('publisher.campaign_stop', pid=publisher._id, campaign_id='XXX')}}'.replace('XXX', campaign_id);

                $('.form-published').attr('method', 'POST');
                $('.form-published').attr('action', action);
                $('.form-published').submit();
            });

            function publishCampaign(formClass, campaignIDFormElementInputId){
                var campaign_id = $(formClass).find('input[id=' + campaignIDFormElementInputId + ']').val();
                var action = '{{ url_for('publisher.campaign_publish', pid=publisher._id, campaign_id='XXX')}}'.replace('XXX', campaign_id);

                $(formClass).attr('method', 'POST');
                $(formClass).attr('action', action);
                $(formClass).submit();
            }

            function editCampaign(formClass, campaignIDFormElementInputId){
                var campaign_id = $(formClass).find('input[id=' + campaignIDFormElementInputId + ']').val();
                var action = '{{ url_for('publisher.campaign_edit', pid=publisher._id, campaign_id='XXX')}}'.replace('XXX', campaign_id);

                $(formClass).attr('method', 'GET');
                $(formClass).attr('action', action);
                $(formClass).submit();
            }

            // Listener - Triggered when the share button is clicked/shown
            // so that we can ste the campaign id in a hidden field and it
            // can be accessed when submitting the modal.
            $('.campaign-share-modal').on('show.bs.modal', function (event) {
                var triggerButton = $(event.relatedTarget);
                var campaignId = triggerButton.data('campaign-id');

                var modal = $(this);
                modal.find('.modal-body input[id=share-campaign-id]').val(campaignId);
            });

            $( ".btn-share-campaign" ).click(function() {
                var campaign_id = $('#share-campaign-id').val();

                // Construct the message.
                var message = "Hello!" +
                    "\n\nCheck out how your ad campaign in '{{ publisher.name }}' is doing:" +
                    "\n{{ config['SERVER_HOST'] }}/admin/advertiser/campaign/" + campaign_id +
                    "\n\nCheers," +
                    "\n\nThe Lidheza Team";

                // Send the share e-mail.
                $.ajax({
                    url: "//formspree.io/" + $('#share-email').val(),
                    method: "POST",
                    data: {
                        "message": message,
                        "subject": "Your Advertisement Stats with {{ publisher.name }}",
                        "replyto": "lidheza@assemblio.com"
                    },
                    dataType: "json"
                }).done(function() {
                    // Close the modal.
                    $('.campaign-share-modal').modal('hide')
                });
            });
        });

    </script>
{% endblock %}

{% block rows %}
    <div class="row">
        <div class="col-sm-12">
            <h2>{{ publisher.name }}</h2>
            <h4>Your default rate is <span class="label label-primary">{{ publisher.impressionRate }} EUR</span> per impression (<a href="" data-toggle="modal" data-target="#myModal">edit</a>).</h4>

            <!-- Modal -->
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Impression Rate</h4>
                  </div>
                    <form action="{{ url_for('publisher.update_impression_rate', pid=publisher._id) }}" method="POST">
                      <div class="modal-body">
                          <div class="form-group">
                              {{ rateform.rate.label }}
                              {{ rateform.rate(class="form-control") }}
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                      </div>
                    </form>
                </div>
              </div>
            </div>
            <hr>
        </div>

        <div class="col-sm-12 text-center" style="padding-bottom:25px;">
            <form action="{{ url_for('publisher.campaign_create', pid=publisher._id) }}" method="GET">
                <input type="submit" class="btn btn-success btn-campaign" value="New Campaign">
            </form>
        </div>


        <!-- PUBLISHED -->
        {% if published_campaigns|length > 0 %}
        <div class="col-sm-12">
            <h3>Published</h3>
            <hr>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Length</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Impressions</th>
                        <th>Rate</th>
                        <th>Current Revenue</th>
                        <th>Revenue Goal</th>
                        <th>Operations</th>
                    </tr>
                </thead>
                <tbody>
                {% for campaign in published_campaigns %}
                    <tr>
                        <td>
                            <a href="{{ campaign.url }}" target="_blank">{{ campaign.name }}</a>
                        </td>
                        <td>
                            {{ (campaign.end - campaign.start).days }} days
                        </td>
                        <td>
                            {{ campaign.start.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.end.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.impressions.count|thousands_seperator }} / {{ campaign.impressions.goal|thousands_seperator }}
                        </td>
                        <td>
                            {{  campaign.impressions.rate }}
                        </td>
                        <td>
                            {{ (campaign.impressions.count * campaign.impressions.rate - (campaign.impressions.count * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            {{ (campaign.impressions.goal * campaign.impressions.rate - (campaign.impressions.goal * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            <form class="form-published" action="" method="">
                                <input type="hidden" id="published-campaign-id" value="{{ campaign._id }}"/>
                                <button type="button" class="btn btn-default btn-primary btn-sm btn-share-published" aria-label="Share" data-campaign-id="{{ campaign._id }}" data-toggle="modal" data-target=".campaign-share-modal">
                                    <span class="glyphicon glyphicon-share" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-default btn-primary btn-sm btn-edit-published" aria-label="Edit">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-default btn-danger btn-sm btn-stop-published" aria-label="Stop">
                                    <span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
                                </button>
                            </form>
                        </td>
                    </tr>
                </tbody>
                {% endfor %}
            </table>
        </div>
        {% endif %}


        <!-- STOPPED -->
        {% if stopped_campaigns|length > 0 %}
        <div class="col-sm-12">
            <h3>Stopped</h3>
            <hr>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Length</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Impressions</th>
                        <th>Rate</th>
                        <th>Current Revenue</th>
                        <th>Revenue Goal</th>
                        <th>Operations</th>
                    </tr>
                </thead>
                <tbody>
                {% for campaign in stopped_campaigns %}
                    <tr>
                        <td>
                            <a href="{{ campaign.url }}" target="_blank">{{ campaign.name }}</a>
                        </td>
                        <td>
                            {{ (campaign.end - campaign.start).days }} days
                        </td>
                        <td>
                            {{ campaign.start.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.end.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.impressions.count|thousands_seperator }} / {{ campaign.impressions.goal|thousands_seperator }}
                        </td>
                        <td>
                            {{ campaign.impressions.rate }}
                        </td>
                        <td>
                            {{ (campaign.impressions.count * campaign.impressions.rate - (campaign.impressions.count * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            {{ (campaign.impressions.goal * campaign.impressions.rate - (campaign.impressions.goal * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            <form class="form-stopped" action="" method="">
                                <input type="hidden" id="stopped-campaign-id" value="{{ campaign._id }}"/>
                                <button type="button" class="btn btn-default btn-primary btn-sm btn-share-stopped" aria-label="Share" data-campaign-id="{{ campaign._id }}" data-toggle="modal" data-target=".campaign-share-modal">
                                    <span class="glyphicon glyphicon-share" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-default btn-primary btn-sm btn-edit-stopped" aria-label="Edit">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-default btn-success btn-sm btn-play-stopped" aria-label="Play">
                                    <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
                                </button>
                            </form>
                        </td>
                    </tr>
                </tbody>
                {% endfor %}
            </table>
        </div>
        {% endif %}


        <!-- DRAFTS -->
        {% if draft_campaigns|length > 0 %}
        <div class="col-sm-12">
            <h3>Drafts</h3>
            <hr>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Length</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Impressions</th>
                        <th>Rate</th>
                        <th>Current Revenue</th>
                        <th>Revenue Goal</th>
                        <th>Operations</th>
                    </tr>
                </thead>
                <tbody>
                {% for campaign in draft_campaigns %}
                    <tr>
                        <td>
                            <a href="{{ campaign.url }}" target="_blank">{{ campaign.name }}</a>
                        </td>
                        <td>
                            {{ (campaign.end - campaign.start).days }} days
                        </td>
                        <td>
                            {{ campaign.start.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.end.strftime('%d-%b-%Y') }}
                        </td>
                        <td>
                            {{ campaign.impressions.count|thousands_seperator }} / {{ campaign.impressions.goal|thousands_seperator }}
                        </td>
                        <td>
                            {{  campaign.impressions.rate }}
                        </td>
                        <td>
                            {{ (campaign.impressions.count * campaign.impressions.rate - (campaign.impressions.count * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            {{ (campaign.impressions.goal * campaign.impressions.rate - (campaign.impressions.goal * campaign.impressions.rate * config['COMMISSION']|float))|to_currency }}
                        </td>
                        <td>
                            <form class="form-draft" action="" method="">
                                <input type="hidden" id="draft-campaign-id" value="{{ campaign._id }}"/>
                                <button type="button" class="btn btn-default btn-primary btn-sm btn-edit-draft" aria-label="Edit">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                </button>
                                {% if campaign.assets and campaign.assets|length > 0 %}
                                <button type="button" class="btn btn-default btn-success btn-sm btn-play-draft" aria-label="Play">
                                    <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-danger btn-primary btn-sm btn-delete-draft" aria-label="Delete">
                                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                </button>
                            </form>
                        </td>
                    </tr>
                </tbody>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>


    <!-- Small modal -->
    <div class="modal fade campaign-share-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <input type="hidden" id="share-campaign-id"/>
                            <label for="share-email">Share statistics:</label>
                            <input type="text" class="form-control" id="share-email" name="share-email" placeholder="E-mail"/>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-sm" data-dismiss="modal" aria-label="Cancel">Cancel</button>
                    <button type="button" class="btn btn-default btn-sm btn-share-campaign" aria-label="Share">Share</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}